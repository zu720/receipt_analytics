<!-- index.html 20260114ver -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>レシートこまかく・みえ～る</title>

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --accent:#2563eb; --accent2:#1d4ed8;
      --shadow: 0 10px 24px rgba(17,24,39,.08);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(29,78,216,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    }
    .wrap{ max-width:1200px; margin:28px auto; padding:0 16px; }
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius: var(--radius); padding:18px; margin:14px 0;
      box-shadow: var(--shadow);
    }
    h1{ font-size:16px; margin:0 0 6px 0; letter-spacing:.2px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h2{ font-size:13px; margin:0 0 12px 0; color:var(--muted); font-weight:800; }
    .sub{ font-size:12px; color:var(--muted); margin:0 0 10px 0; }
    .badge{
      font-size:12px; color:#fff;
      background: linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1));
      border-radius:999px; padding:4px 10px; font-weight:800;
    }

    .row{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    .row4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px; }
    @media(max-width:1000px){ .row,.row4{ grid-template-columns:1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px; }
    input,select{
      width:100%; padding:11px 12px; border-radius: 12px;
      border:1px solid var(--line); background:#fff; color:var(--text); outline:none;
      transition: box-shadow .15s, border-color .15s;
    }
    input:focus,select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .drop{
      border:2px dashed rgba(37,99,235,.35);
      border-radius: var(--radius);
      padding:16px; text-align:center; color:var(--muted);
      background: linear-gradient(180deg, rgba(37,99,235,.05), rgba(37,99,235,.00));
    }
    .drop b{ color:var(--text); }

    .btn{
      padding:10px 14px; border-radius: 12px; border:1px solid var(--line);
      background:#fff; color:var(--text); cursor:pointer;
      transition: transform .06s, box-shadow .15s, border-color .15s;
    }
    .btn:hover{ border-color: rgba(37,99,235,.45); box-shadow: 0 10px 20px rgba(37,99,235,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(37,99,235,1), rgba(29,78,216,1));
      border-color: rgba(29,78,216,1); color:#fff;
    }
    .btn.primary:hover{ box-shadow: 0 14px 26px rgba(37,99,235,.22); }

    .kpi{ display:grid; grid-template-columns:repeat(6,1fr); gap:12px; }
    @media(max-width:1100px){ .kpi{ grid-template-columns:repeat(3,1fr); } }
    @media(max-width:700px){ .kpi{ grid-template-columns:repeat(2,1fr); } }

    .tile{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      background:#fff;
    }
    .tile .k{ font-size:12px; color:var(--muted); }
    .tile .v{ font-size:18px; font-weight:800; margin-top:6px; }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
    }
    th,td{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align: top;
    }
    th{ background: #f9fafb; color: var(--muted); font-weight:800; }
    tr:last-child td{ border-bottom:none; }
    tbody tr:hover td{ background: rgba(37,99,235,.04); }

    .right{text-align:right;}
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:12px; color:var(--muted); }

    .split{ display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start; }
    @media(max-width:1000px){ .split{ grid-template-columns: 1fr; } }

    .listBox{ border:1px solid var(--line); border-radius: var(--radius); background:#fff; overflow:hidden; }
    .listHeader{ padding:12px 14px; border-bottom:1px solid var(--line); background:#fff; position: sticky; top: 0; z-index: 5; }
    .listBody{
      max-height: calc(100vh - 420px);
      min-height: 220px;
      overflow:auto;
      padding: 10px;
    }
    .rcptBtn{
      width:100%; text-align:left; border:1px solid var(--line);
      background:#fff; border-radius: 14px; padding:10px 12px;
      cursor:pointer; margin-bottom:10px;
      transition: box-shadow .15s, border-color .15s, transform .06s;
    }
    .rcptBtn:hover{ border-color: rgba(37,99,235,.45); box-shadow: 0 10px 20px rgba(37,99,235,.10); }
    .rcptBtn:active{ transform: translateY(1px); }
    .rcptBtn.active{ border-color: rgba(37,99,235,.9); box-shadow: 0 12px 24px rgba(37,99,235,.18); }

    .rcptTop{ display:flex; justify-content:space-between; gap:10px; font-weight:800; }
    .rcptMid{ margin-top:4px; color:var(--muted); font-size:12px; }
    .rcptBot{ margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; }
    .pill{ border:1px solid var(--line); border-radius:999px; padding:2px 8px; background:#fff; }

    .receiptBox{ border:1px solid var(--line); border-radius: var(--radius); background:#fff; overflow:hidden; }
    .receiptHeader{
      position: sticky; top: 0; z-index: 10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      padding: 12px 14px;
    }
    .nav{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .metaLine{ margin-top:8px; font-weight:800; }
    .hintKeys{ margin-top:6px; }
    .receiptBody{
      max-height: calc(100vh - 340px);
      overflow:auto;
      padding:14px;
    }

    .bar{ height:10px; border-radius:999px; background: rgba(37,99,235,.12); overflow:hidden; }
    .bar > div{ height:100%; background: rgba(37,99,235,.70); }

    .rankWrap{ overflow:auto; border-radius: var(--radius); border:1px solid var(--line); }
    .rankTable td, .rankTable th{ white-space:nowrap; }
    .rankClickable{ cursor:pointer; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <h1>
        レシートこまかくみえ～る
        <span class="badge" id="chainBadge">CHAIN: -</span>
      </h1>
      <div class="sub">レシート単位で特定の会員の明細を閲覧するツール</div>

      <div class="drop" id="drop">
        <b>明細CSVをここにドラッグ&ドロップ</b>（または）
        <input type="file" id="file" accept=".csv" />
        <div class="small" style="margin-top:10px">
          <div class="muted">必須カラム名（CSVヘッダにこの文字列が必要）</div>
          <div class="mono" id="reqCols">-</div>
          <div class="muted" style="margin-top:6px">
            ※ 列名が違う場合は <span class="mono">app.js</span> の <span class="mono">PROFILES</span> を修正
          </div>
        </div>
      </div>

      <div class="small muted" id="status" style="margin-top:10px">CSV未読込</div>
    </div>

    <!-- 0) 会員探索（ランキング） -->
    <div class="card">
      <h2>0) 会員の当たりを付ける（対象商品ベースのランキング）</h2>

      <div class="row4">
        <div>
          <label>JANコード（部分一致）</label>
          <input id="rankJan" class="mono" placeholder="例: 498..." />
        </div>
        <div>
          <label>商品名（部分一致）</label>
          <input id="rankItem" placeholder="例: ロキソニン" />
        </div>
        <div>
          <label>指標</label>
          <select id="rankMetric">
            <option value="sales_desc">対象商品 売上（高い順）</option>
            <option value="qty_desc">対象商品 点数（多い順）</option>
            <option value="rcpt_desc">対象商品 レシート枚数（多い順）</option>
            <option value="last_desc">直近購買日時（新しい順）</option>
          </select>
        </div>
        <div>
          <label>表示件数</label>
          <select id="rankLimit">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn primary" id="rankRefresh">ランキング更新</button>
        <div class="small muted" id="rankInfo" style="align-self:center">CSV読込後に有効</div>
      </div>

      <div style="margin-top:12px" class="rankWrap">
        <table class="rankTable">
          <thead>
            <tr>
              <th>#</th>
              <th>会員ID</th>
              <th class="right">対象商品売上</th>
              <th class="right">対象商品点数</th>
              <th class="right">対象商品レシート枚数</th>
              <th>直近購買</th>
              <th class="right">利用店舗数</th>
            </tr>
          </thead>
          <tbody id="rankTable">
            <tr><td colspan="7" class="muted">CSV未読込</td></tr>
          </tbody>
        </table>
      </div>

      <div class="small muted" style="margin-top:8px">
        ※ ここは「一致した明細のみ」で集計（同時購入分は入れない）。深掘りは下のレシートで見る。
      </div>
    </div>

    <!-- ① 会員選択 -->
    <div class="card">
      <h2>① 会員を選ぶ & 絞り込み</h2>

      <div class="row">
        <div>
          <label>会員（匿名会員番号）</label>
          <select id="member"><option value="">（CSV読込後に選択）</option></select>
        </div>
        <div>
          <label>会員検索（部分一致）</label>
          <input id="memberSearch" class="mono" placeholder="例: 7130..." />
        </div>
        <div>
          <label>買上日（任意）</label>
          <input id="dateFilter" type="date" />
        </div>
      </div>

      <div style="margin-top:12px" class="row4">
        <div>
          <label>店舗</label>
          <select id="storeFilter"><option value="">（全て）</option></select>
        </div>
        <div>
          <label>ライン</label>
          <select id="lineFilter"><option value="">（全て）</option></select>
        </div>
        <div>
          <label>コーナー</label>
          <select id="cornerFilter"><option value="">（全て）</option></select>
        </div>
        <div>
          <label>大分類</label>
          <select id="catLFilter"><option value="">（全て）</option></select>
        </div>
      </div>

      <div style="margin-top:12px" class="row4">
        <div>
          <label>中分類</label>
          <select id="catMFilter"><option value="">（全て）</option></select>
        </div>
        <div>
          <label>小分類</label>
          <select id="catSFilter"><option value="">（全て）</option></select>
        </div>
        <div>
          <label>JANコード</label>
          <input id="janFilter" class="mono" placeholder="部分一致OK" />
        </div>
        <div>
          <label>商品名</label>
          <input id="itemFilter" placeholder="部分一致OK" />
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div>
          <label>レシート一覧ソート</label>
          <select id="rcptSort">
            <option value="dt_desc">日時（新しい順）</option>
            <option value="dt_asc">日時（古い順）</option>
            <option value="sales_desc">売上（高い順）</option>
            <option value="sales_asc">売上（低い順）</option>
            <option value="qty_desc">点数（多い順）</option>
            <option value="qty_asc">点数（少ない順）</option>
          </select>
        </div>

        <div>
          <label>商品絞り込みの表示モード</label>
          <select id="productScope">
            <option value="detail_only">一致した明細だけ表示（軽い）</option>
            <option value="receipt_all">一致レシートを抽出し、明細は全表示（同時購入が見える）</option>
          </select>
        </div>

        <div></div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn primary" id="apply">反映</button>
        <button class="btn" id="clear">クリア</button>
      </div>
    </div>

    <!-- ② 会員サマリー -->
    <div class="card">
      <h2>② 会員サマリー（条件内）</h2>
      <div class="kpi">
        <div class="tile"><div class="k">取引数（レシート）</div><div class="v" id="k_rcpt">-</div></div>
        <div class="tile"><div class="k">購買金額</div><div class="v" id="k_sales">-</div></div>
        <div class="tile"><div class="k">購買点数</div><div class="v" id="k_qty">-</div></div>
        <div class="tile"><div class="k">来店日数</div><div class="v" id="k_days">-</div></div>
        <div class="tile"><div class="k">利用店舗数</div><div class="v" id="k_stores">-</div></div>
        <div class="tile"><div class="k">平均客単価</div><div class="v" id="k_atv">-</div></div>
      </div>
      <div class="small muted" style="margin-top:8px">※ 絞り込み条件をかけた後の範囲で集計</div>
    </div>

    <!-- ③ レシート -->
    <div class="card">
      <h2>③ レシート一覧 → ワンクリックでジャンプ（＋左右キー）</h2>

      <div class="split" style="margin-top:12px">
        <div class="listBox">
          <div class="listHeader">
            <div class="muted small">レシート一覧（クリックで切替）</div>
            <div class="mono" id="listInfo">-</div>
          </div>
          <div class="listBody" id="rcptList">
            <div class="muted small">会員を選んで反映すると表示されます</div>
          </div>
        </div>

        <div class="receiptBox">
          <div class="receiptHeader">
            <div class="nav">
              <button class="btn" id="prev">← 前</button>
              <button class="btn" id="next">次 →</button>
              <span class="muted mono" id="rcptIndex">-</span>

              <span style="flex:1"></span>

              <label class="muted small" style="margin:0">レシートソート</label>
              <select id="rcptSort2" style="width:220px">
                <option value="dt_desc">日時（新しい順）</option>
                <option value="dt_asc">日時（古い順）</option>
                <option value="sales_desc">売上（高い順）</option>
                <option value="sales_asc">売上（低い順）</option>
                <option value="qty_desc">点数（多い順）</option>
                <option value="qty_asc">点数（少ない順）</option>
              </select>

              <label class="muted small" style="margin:0">明細ソート</label>
              <select id="itemSort" style="width:220px">
                <option value="amt_desc">金額（高い順）</option>
                <option value="amt_asc">金額（低い順）</option>
                <option value="qty_desc">点数（多い順）</option>
                <option value="qty_asc">点数（少ない順）</option>
                <option value="name_asc">商品名（A→Z）</option>
              </select>
            </div>

            <div class="metaLine mono" id="rcptMeta">-</div>
            <div class="small muted hintKeys">ショートカット：<span class="mono">← / →</span> でレシート切替（入力中は無効）</div>
          </div>

          <div class="receiptBody">
            <div class="small muted">レシート合計（このレシート内）</div>
            <div class="row" style="grid-template-columns:1fr 1fr 1fr;gap:12px">
              <div class="tile"><div class="k">売上</div><div class="v" id="r_sales">-</div></div>
              <div class="tile"><div class="k">点数</div><div class="v" id="r_qty">-</div></div>
              <div class="tile"><div class="k">商品行数</div><div class="v" id="r_lines">-</div></div>
            </div>

            <div style="margin-top:12px">
              <div class="small muted">商品明細（このレシート内）</div>
              <table>
                <thead>
                  <tr>
                    <th>商品名</th>
                    <th class="right">金額</th>
                    <th class="right">点数</th>
                    <th style="width:25%">構成比（売上）</th>
                  </tr>
                </thead>
                <tbody id="items"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

    </div>

  </div>

  <script src="./app.js"></script>
</body>
</html>
